# Nginx Security Configuration
# Add these configurations to your nginx server block

# Security Headers
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' fonts.googleapis.com; font-src 'self' fonts.gstatic.com; img-src 'self' data:; connect-src 'self'; frame-ancestors 'none'; base-uri 'self'; form-action 'self';" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-Frame-Options "DENY" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;
add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=()" always;

# HSTS (uncomment if using HTTPS)
# add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

# Hide nginx version and server information
server_tokens off;

# Rate limiting
limit_req_zone $binary_remote_addr zone=api:10m rate=5r/s;
limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;

# Apply rate limiting
location / {
    limit_req zone=general burst=20 nodelay;
    try_files $uri $uri/ =404;
}

# Block access to sensitive files
location ~ /\.(ht|env|git) {
    deny all;
    return 404;
}

location ~ \.(log|sql|conf|bak|backup|old|tmp|temp)$ {
    deny all;
    return 404;
}

# Block suspicious requests
location ~* "(eval\()" {
    deny all;
    return 404;
}

location ~* "(<|%3C).*script.*(>|%3E)" {
    deny all;
    return 404;
}

# Security headers for static files
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|webp)$ {
    expires 1M;
    add_header Cache-Control "public, immutable";
    add_header X-Content-Type-Options "nosniff" always;
}

# Deny access to backup and temporary files
location ~* \.(bak|config|sql|fla|psd|ini|log|sh|inc|swp|dist)|~$ {
    deny all;
    return 404;
}

# Size limits
client_max_body_size 10M;
client_body_buffer_size 128k;
client_header_buffer_size 1k;
large_client_header_buffers 4 4k;

# Timeout settings
client_body_timeout 12;
client_header_timeout 12;
keepalive_timeout 15;
send_timeout 10;

# Buffer overflow protection
client_body_buffer_size 1K;
client_header_buffer_size 1k;
client_max_body_size 1k;
large_client_header_buffers 2 1k;
